{"code":"import { Roles, Setups } from \"Creep_Setups/Setups\";\r\nimport { config } from \"config\";\r\nimport { Manager } from \"Manager\";\r\nimport { ManagerPriority } from \"./ManagerPriority\";\r\nexport class UpgradeManager extends Manager {\r\n    constructor(upgradeSite, prio = ManagerPriority.Upgrading.upgrade) {\r\n        super(upgradeSite, \"UpgradeManager_\" + upgradeSite.controller.id, prio);\r\n        this.controller = upgradeSite.controller;\r\n        this.upgraders = this.creepsByRole[Roles.upgrader];\r\n        this.upgradeSite = upgradeSite;\r\n        this.room = upgradeSite.room;\r\n        this.powerNeeded = 0;\r\n    }\r\n    handleUpgrader(upgrader) {\r\n        var _a;\r\n        if (upgrader.store.energy > 0) {\r\n            if (this.upgradeSite.link && this.upgradeSite.link.hits < this.upgradeSite.link.hitsMax) {\r\n                upgrader.goRepair(this.upgradeSite.link);\r\n                return;\r\n            }\r\n            if (this.upgradeSite.container && this.upgradeSite.container.hits < this.upgradeSite.container.hitsMax) {\r\n                upgrader.goRepair(this.upgradeSite.container);\r\n                return;\r\n            }\r\n            if (this.upgradeSite.constructionSite) {\r\n                upgrader.goBuild(this.upgradeSite.constructionSite);\r\n                return;\r\n            }\r\n            if (!(((_a = this.upgradeSite.controller.sign) === null || _a === void 0 ? void 0 : _a.text) == config.signature)) {\r\n                upgrader.goSign(this.capital.controller);\r\n                return;\r\n            }\r\n            upgrader.goUpgrade(this.upgradeSite.controller);\r\n            return;\r\n        }\r\n        else {\r\n            if (this.upgradeSite.link && this.upgradeSite.link.energy > 0) {\r\n                upgrader.goWithdraw(this.upgradeSite.link);\r\n                return;\r\n            }\r\n            else if (this.upgradeSite.container && this.upgradeSite.container.energy > 0) {\r\n                upgrader.goWithdraw(this.upgradeSite.container);\r\n                return;\r\n            }\r\n            else if (this.upgradeSite.container) {\r\n                return;\r\n            }\r\n            else {\r\n                let drops = _.filter(this.room.droppedEnergy, r => r.amount > upgrader.store.getCapacity() / 4);\r\n                let structs = _.filter(this.capital.room.storageUnits, r => r.store.energy > upgrader.store.getCapacity() / 4);\r\n                let targets = _.merge(drops, structs);\r\n                //console.log(JSON.stringify(this.room.drops))\r\n                let target = upgrader.pos.findClosestByRange(targets);\r\n                if (target) {\r\n                    upgrader.goWithdraw(target);\r\n                }\r\n                return;\r\n            }\r\n        }\r\n    }\r\n    init() {\r\n        if (this.capital.level < 3 || !this.capital.storage) { // let workers upgrade early on until we have a storage\r\n            return;\r\n        }\r\n        console.log(this.capital.assets[RESOURCE_ENERGY]);\r\n        if (this.capital.assets[RESOURCE_ENERGY] > 100000 || this.controller.ticksToDowngrade < 500) {\r\n            let setup = this.capital.level == 8 ? Setups.upgraders.rcl8 : Setups.upgraders.default;\r\n            if (this.capital.level == 8) {\r\n                this.spawnList(1, setup);\r\n            }\r\n            else {\r\n                let upgradePowerEach = setup.getBodyPotential(WORK, this.capital);\r\n                let extra = Math.max(this.capital.assets[RESOURCE_ENERGY] - 80000, 0); // how much energy we have spare. 80k is cutoff point TODO add to config\r\n                let upgradePartNeeded = Math.floor(extra / 10000); //How many parts to spawn TODO add to config\r\n                if (extra > 800000) {\r\n                    upgradePartNeeded *= 4; //MORE POWER if we have lots of energy lying around\r\n                }\r\n                else if (extra > 500000) {\r\n                    upgradePartNeeded *= 2;\r\n                }\r\n                console.log(upgradePartNeeded);\r\n                this.powerNeeded = upgradePartNeeded;\r\n                const upgradersNeeded = Math.ceil(upgradePartNeeded / upgradePowerEach);\r\n                this.spawnList(upgradersNeeded, setup);\r\n            }\r\n            this.powerNeeded += 1;\r\n        }\r\n    }\r\n    run() {\r\n        _.forEach(this.upgraders, r => this.handleUpgrader(r));\r\n    }\r\n}\r\n//# sourceMappingURL=UpgradeManager.js.map","references":["C:/Users/ADMIN BOI/Documents/GitHub/ScreepsProject/src/Buildings/UpgradeSite.ts","C:/Users/ADMIN BOI/Documents/GitHub/ScreepsProject/src/Creep_Setups/Setups.ts","C:/Users/ADMIN BOI/Documents/GitHub/ScreepsProject/src/config.ts","C:/Users/ADMIN BOI/Documents/GitHub/ScreepsProject/src/Manager.ts","C:/Users/ADMIN BOI/Documents/GitHub/ScreepsProject/src/Managers/ManagerPriority.ts"],"map":"{\"version\":3,\"file\":\"UpgradeManager.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../../src/Managers/UpgradeManager.ts\"],\"names\":[],\"mappings\":\"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\"}"}
